# C++routines

## Table of Contents

* [1. Environmental Preparation](#1-environmental-preparation)
    * [1.1 x86/arm PCIe platform](#11-x86arm-pice=platform)
    * [1.2 SoC Platform](#12-soc-platform)
* [2. Program Compilation](#2-program-compilation)
    * [2.1 x86/arm PCIe platform](#21-x86/arm-PCIe-platform)
    * [2.2 SoC Platform](#22-SoC-Platform)
* [3. Inference testing](#3-Inference-testing)
    * [3.1 Parameter Description](#31-Parameter-Description)
    * [3.2 Test text](#32-Test-text)
    * [3.3 Test dev](#33-Test-dev)
    * [3.4 Test dataset](#34-Test-dataset)

C++routines are provided in the cpp directory for reference, as follows:
|Sequence Number | C++Routine | Description|
| ---- | ------------- | ----------------------------------- |
| 1 | bert_ SAIL | Using SAIL Reasoning|

## 1. Environmental Preparation
### 1.1 x86/arm PCIe platform
If you have installed a PCIe accelerator card (such as an SC series accelerator card) on the x86/arm platform, you can directly use it as a development and runtime environment. You need to install libsophon, sophon opencv, and sophon ffmpeg. For specific steps, please refer to [Development and Runtime Environment Construction of x86 pcie Platform](../../../docs/Environment_install_Guide_EN.md#3-x86-pcie-Platform-Development-and-Runtime-Environment-Construction) or [Development and Runtime Environment Construction of arm pcie Platform](../../../docs/Environment_install_Guide_EN.md#5-arm-pcie-Platform-Development-and-Runtime-Environment-Construction).



### 1.2 SoC Platform
If you use the SoC platform (such as SE, SM series Edge device), the corresponding libsophon, sophon opencv, and sophon ffmpeg runtime library packages have been pre installed under '/opt/sophon/' after the reboot. You can directly use it as the runtime environment. Usually, an x86 host is also required as the development environment for cross compiling C++ programs.


## 2. Program Compilation
C++programs need to compile executable files before running.
### 2.1 x86/arm PCIe platform
You can directly compile programs on the PCIe platform:
#### 2.1.1 sail
```bash
cd cpp/bert_sail
mkdir build && cd build
cmake .. 
make
cd ..
```
After compilation is completed, it will be displayed in bert_sail.pcie in the save directory bert_sail

### 2.2 SoC Platform
Usually, programs are cross compiled on x86 hosts. You need to use the SOPHON SDK to build a cross compilation environment on the x86 host, and package the header and library files that the program depends on into the soc sdk directory. For details, please refer to [Cross Compilation Environment Building](../../../docs/Environment_INSTALL_Guide_EN.md#41-Cross-compiling-Environment-Construction). This routine mainly relies on the libsophon, sophon opencv, and sophon ffmpeg runtime packages.

After the cross compilation environment is established, use the cross compilation toolchain to compile and generate executable files:

#### 2.2.1 sail
If you use sophon-sail, you should refer to [cross compile sophon-sail](../../../docs/Environment_Install_Guide_EN.md#42-cross-compiling-and-sophon-sail-installation)，configure sophon-sail for your soc，then:

```bash
cd cpp/bert_sail
mkdir build && cd build
#请根据实际情况修改-DSDK和-DSAIL_PATH的路径，需使用绝对路径。
cmake -DTARGET_ARCH=soc -DSDK=/path_to_sdk/soc-sdk -DSAIL_PATH=/path_to_sail/sophon-sail/build_soc/sophon-sail ..
make
```
After compilation is completed, it will be displayed in bert_sail.soc in the save directory bert_sail。

## 3. Inference testing
For PCIe platforms, inference testing can be conducted directly on the PCIe platform; For the SoC platform, it is necessary to copy the executable files generated by cross compilation, as well as the required models and test data, to the SoC platform for testing. The parameters and operation mode of the test are consistent, and the following will mainly introduce them in PCIe mode.

### 3.1 Parameter Description
The executable program has a set of parameters by default. Please pay attention to passing parameters according to the actual situation_ As an example, the specific parameters for Sail.pcie are as follows:
```bash
Usage: bert_sail.pcie [params]

        --bmodel (value: ../../models/BM1684/bert4torch_output_fp32_1b.bmodel)
                bmodel file path
        --dev_id (value:0)
                TPU device id
        --help (value:true)
                print help information.
        --input (value:"张飞")
                input text or dateset path        
        --vocab_path (value: ../../data/pre_train/chinese-bert-wwm/vocab.txt)
                pre_train vocab file
      
```
**Note:** CPP transfers to participate in Python are different and require the equal sign, such as'/bert_sail.pcie --bmodel=xxx`。
### 3.2 Test Text
The text testing example is as follows, which supports testing files.
```bash
./bert_sail.pcie --input=../../datasets/china-people-daily-ner-corpus/test.txt --bmodel=../../models/BM1684/bert4torchoutput_fp32_1b.bmodel --dev_id=0 
```
After the test is completed, information such as predicted results will be printed.
### 3.3 Test the command line
The text test example is as follows, which supports online command line testing.
Enter a piece of text, such as, Zhang Fei, Liu Bei, Guan Yu, Taoyuan, Sanjieyi.
Extract entities {('Zhang Fei', 'PER'), ('Guan Yu', 'PER'), ('Taoyuan', 'LOC'), ('Liu Bei', 'PER')}
```bash
./bert_sail.pcie --input=dev --bmodel=../../models/BM1684/bert4torch_output_fp32_1b.bmodel --dev_id=0 
```
Enter a text on the command line and output the result.

### 3.4 Test Dataset
The text testing example is as follows, which supports testing files.
```bash
./bert_sail.pcie --input=../../datasets/china-people-daily-ner-corpus、example.test --bmodel=../../models/BM1684/bert4torchoutput_fp32_1b.bmodel --dev_id=0 
```
After the test is completed, the predicted results are saved in 'results/bert4torch_output_fp32_1b.bmodel_test_sail_cpp_result. txt', information such as prediction results and inference time will also be printed.
>**Attention:**

If executing an error in SoC mode:
```bash
./bert_sail.soc: error while loading shared libraries: libsail.so: cannot open shared object file: No such file or directory
```
Please set the following environment variables:
```bash
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/sophon/sophon-sail/lib
```